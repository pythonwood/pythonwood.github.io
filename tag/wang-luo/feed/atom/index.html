<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Linux迷+Python粉 - 网络</title><link href="https://blog.pythonwood.com/" rel="alternate"></link><link href="https://blog.pythonwood.com/tag/wang-luo/feed/atom/index.html" rel="self"></link><id>https://blog.pythonwood.com/</id><updated>2017-11-30T22:12:00+08:00</updated><entry><title>ssh命令：隧道代理+本地端口转发+远程端口转发</title><link href="https://blog.pythonwood.com/2016/02/ssh%E5%91%BD%E4%BB%A4%EF%BC%9A%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86+%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91+%E8%BF%9C%E7%A8%8B%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/" rel="alternate"></link><published>2016-02-15T11:29:00+08:00</published><updated>2017-11-27T22:12:00+08:00</updated><author><name>pythonwood</name></author><id>tag:blog.pythonwood.com,2016-02-15:/2016/02/ssh命令：隧道代理+本地端口转发+远程端口转发/</id><summary type="html">&lt;h3 id="0"&gt;0、前言&lt;a class="headerlink" href="#0" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;nc是一个在网络连接两端的好工具，同时也是也个临时的端口转发的好工具。（永久的端口转发用什么？用iptables）&lt;/p&gt;
&lt;p&gt;ssh也是这方面的好工具，好处是加密可靠可复用在一端操作即可，代价是要有登录帐号。&lt;/p&gt;
&lt;p&gt;我们知道，&lt;span class="caps"&gt;SSH&lt;/span&gt; 会自动加密和解密所有 &lt;span class="caps"&gt;SSH&lt;/span&gt; 客户端与服务端之间的网络数据。但是，&lt;span class="caps"&gt;SSH&lt;/span&gt; 还同时提供了一个非常有用的功能，这就是端口转发。它能够将其他 &lt;span class="caps"&gt;TCP …&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;h3 id="0"&gt;0、前言&lt;a class="headerlink" href="#0" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;nc是一个在网络连接两端的好工具，同时也是也个临时的端口转发的好工具。（永久的端口转发用什么？用iptables）&lt;/p&gt;
&lt;p&gt;ssh也是这方面的好工具，好处是加密可靠可复用在一端操作即可，代价是要有登录帐号。&lt;/p&gt;
&lt;p&gt;我们知道，&lt;span class="caps"&gt;SSH&lt;/span&gt; 会自动加密和解密所有 &lt;span class="caps"&gt;SSH&lt;/span&gt; 客户端与服务端之间的网络数据。但是，&lt;span class="caps"&gt;SSH&lt;/span&gt; 还同时提供了一个非常有用的功能，这就是端口转发。它能够将其他 &lt;span class="caps"&gt;TCP&lt;/span&gt; 端口的网络数据通过 &lt;span class="caps"&gt;SSH&lt;/span&gt;&amp;nbsp;链接来转发，并且自动提供了相应的加密及解密服务。&lt;/p&gt;
&lt;h3 id="1"&gt;1、隧道带理&lt;a class="headerlink" href="#1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;典型应用：翻越高墙&lt;/p&gt;
&lt;p&gt;需要条件：一个国外vps，一个不需要登录（安全）的帐号，一个命令。&lt;/p&gt;
&lt;p&gt;vps新建帐号：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;useradd -g nobody -s /sbin/nologin  gfw &amp;amp;&amp;amp; echo gfw_Passw0rd | passwd --stdin gfw
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;本地ssh连接：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -NfD 6666 gfw@vps -p 2222
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;可选转换：使用privoxy把socks5代理变成http代理供svn，pip，gem，curl等工具使用。&lt;/p&gt;
&lt;h3 id="2"&gt;2、本地端口转发&lt;a class="headerlink" href="#2" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;img alt="tu2" src="https://blog.pythonwood.com/uploads/2016/本地端口转发.jpg" title="2"&gt;&lt;/p&gt;
&lt;p&gt;我们可以将远程机器（LdapClientHost）上的应用直接配置到本机的 7001 端口上（而不是 &lt;span class="caps"&gt;LDAP&lt;/span&gt; 服务器的 389 端口上）。在 LdapClientHost 上执行如下命令即可建立一个 &lt;span class="caps"&gt;SSH&lt;/span&gt;&amp;nbsp;的本地端口转发，例如：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -L 7001:localhost:389 LdapServerHost
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;之后的数据流将会是下面这个样子：&lt;/p&gt;
&lt;p&gt;我们在 LdapClientHost 上的应用将数据发送到本机的 7001 端口上，
而本机的 &lt;span class="caps"&gt;SSH&lt;/span&gt; Client 会将 7001 端口收到的数据加密并转发到 LdapServertHost 的 &lt;span class="caps"&gt;SSH&lt;/span&gt; Server 上。
&lt;span class="caps"&gt;SSH&lt;/span&gt; Server 会解密收到的数据并将之转发到监听的 &lt;span class="caps"&gt;LDAP&lt;/span&gt; 389 端口上，
最后再将从 &lt;span class="caps"&gt;LDAP&lt;/span&gt;&amp;nbsp;返回的数据原路返回以完成整个流程。&lt;/p&gt;
&lt;h3 id="3"&gt;3、远程端口转发&lt;a class="headerlink" href="#3" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;img alt="tu3" src="https://blog.pythonwood.com/uploads/2016/远程端口转发.jpg" title="3"&gt;&lt;/p&gt;
&lt;p&gt;我们在 LdapClientHost 上的应用将数据发送到本机的 7001 端口上，而本机的 &lt;span class="caps"&gt;SSH&lt;/span&gt; Server 会将 7001 端口收到的数据加密并转发到 LdapServertHost 的 &lt;span class="caps"&gt;SSH&lt;/span&gt; Client&amp;nbsp;上。&lt;/p&gt;
&lt;p&gt;在 &lt;span class="caps"&gt;LDAP&lt;/span&gt;&amp;nbsp;服务器（LdapServertHost）端执行如下命令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -R 7001:localhost:389 LdapClientHost
&lt;/pre&gt;&lt;/div&gt;


&lt;h4 id="_1"&gt;区别：&lt;a class="headerlink" href="#_1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;&lt;span class="caps"&gt;SSH&lt;/span&gt; 端口转发自然需要 &lt;span class="caps"&gt;SSH&lt;/span&gt; 连接，而 &lt;span class="caps"&gt;SSH&lt;/span&gt; 连接是有方向的，从 &lt;span class="caps"&gt;SSH&lt;/span&gt; Client 到 &lt;span class="caps"&gt;SSH&lt;/span&gt; Server 。而我们的应用也是有方向的，比如需要连接 &lt;span class="caps"&gt;LDAP&lt;/span&gt; Server 时，&lt;span class="caps"&gt;LDAP&lt;/span&gt; Server 自然就是 Server 端，我们应用连接的方向也是从应用的 Client 端连接到应用的 Server&amp;nbsp;端。如果这两个连接的方向一致，那我们就说它是本地转发。而如果两个方向不一致，我们就说它是远程转发。&lt;/p&gt;
&lt;h3 id="4autosshsupervisior"&gt;4、使用autossh防网络抖动+supervisior进程守护。&lt;a class="headerlink" href="#4autosshsupervisior" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;autossh解决的问题：远程端口转发一旦端口，很难再次建立。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;autossh -M 1932 -NR  1922:localhost:1122 user@vps -p 1122
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;ps可以看到实质是这样的：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -L 1932:127.0.0.1:1932 -R 1932:127.0.0.1:1933 -NR 1922:localhost:1122 -p 1122 user@vps
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;分析：使用回路，将本地1933端口，（远程转发）映射到远端1932，（本地转发）到本机的1932。形成回路。&lt;/p&gt;
&lt;p&gt;supervisior解决的问题：autossh的进程守护&lt;/p&gt;
&lt;p&gt;因此，使用supervisior守护autossh，autossh守护ssh。达到自动启动和守护端口转发的目的。&lt;/p&gt;
&lt;h3 id="5"&gt;5、综合使用&lt;a class="headerlink" href="#5" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;案例一、如何2222端口被封，如果绕过封死2222端口的防火墙直接ssh到内网机器。（就是说限某几个端口是有局限的）&lt;/p&gt;
&lt;p&gt;1、登录最重要的机器把2222端口映射到12222端口：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -gfNL 12222:0.0.0.0:2222 localhost -p2222
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;2、使用该机器做隧道代理访问其他内网机器：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -NfD 10000 user@host -p12222
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;3、ssh绕道访问其他内网机器：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -o &amp;quot;ProxyCommand=nc -x localhost:10000 %h %p&amp;quot; user@host -p2222
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;巧妙结合的ssh和nc，都是linux自带工具，没有依赖。&lt;/p&gt;
&lt;p&gt;案例二、借助远程vps让两台不能直接相通的机器相互能访问。&lt;/p&gt;
&lt;p&gt;有主机vps和主机A、B。A、B无法直连，通过“中介”搭桥相连。（两台机器都能主动ssh到vps就能完成。）&lt;/p&gt;
&lt;p&gt;A要ssh到B（B要ssh到A是同理）：&lt;/p&gt;
&lt;p&gt;1、主机B用ssh远程转发自己的2222端口到vps的127.0.0.1:12222&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -NfR 12222:127.0.0.1:2222 user@vps -p2222
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;2、主机A用ssh本地转发vps的127.0.0.1:12222到本地的127.0.0.1:12222&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -NfL 12222:127.0.0.1:12222 user@vps -p2222
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;3、主机A登录主机B&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh user@localhost -p12222
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;参考：&lt;/p&gt;
&lt;p&gt;实战 &lt;span class="caps"&gt;SSH&lt;/span&gt;&amp;nbsp;端口转发&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/"&gt;https://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;使用supervisor托管shadowsocks&lt;/p&gt;
&lt;p&gt;&lt;a href="https://blog.phpgao.com/supervisor_shadowsocks.html"&gt;https://blog.phpgao.com/supervisor_shadowsocks.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;SSH反向连接及Autossh&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.cnblogs.com/eshizhan/archive/2012/07/16/2592902.html"&gt;http://www.cnblogs.com/eshizhan/archive/2012/07/16/2592902.html&lt;/a&gt;&lt;/p&gt;</content><category term="ssh"></category><category term="加密隧道"></category><category term="privoxy"></category><category term="代理"></category><category term="远程连接"></category><category term="网络"></category></entry><entry><title>不能小看的nc——实践TCP协议第四层的软件（传输层）</title><link href="https://blog.pythonwood.com/2015/12/%E4%B8%8D%E8%83%BD%E5%B0%8F%E7%9C%8B%E7%9A%84nc%E2%80%94%E2%80%94%E5%AE%9E%E8%B7%B5TCP%E5%8D%8F%E8%AE%AE%E7%AC%AC%E5%9B%9B%E5%B1%82%E7%9A%84%E8%BD%AF%E4%BB%B6%EF%BC%88%E4%BC%A0%E8%BE%93%E5%B1%82%EF%BC%89/" rel="alternate"></link><published>2015-12-20T21:20:00+08:00</published><updated>2017-11-30T22:12:00+08:00</updated><author><name>pythonwood</name></author><id>tag:blog.pythonwood.com,2015-12-20:/2015/12/不能小看的nc——实践TCP协议第四层的软件（传输层）/</id><summary type="html">&lt;p&gt;nc命令全名为netcat，顾名思义就是通过TCP或UDP从网络读写数据。&lt;/p&gt;
&lt;p&gt;很多事情不一定非得抓包，nc也能发挥巨大作用。&lt;/p&gt;
&lt;h3 id="1"&gt;1、传输文件&lt;a class="headerlink" href="#1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id="_1"&gt;使用&amp;lt;&amp;gt;重定向符（只适用单文件，不推荐、失败时 &amp;ldquo;&amp;gt;&amp;rdquo; 产生空文件）&lt;a class="headerlink" href="#_1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nc -l 8888 &amp;lt; demo.txt        # 在本机8888端口侦听TCP连接，将收到的数据写入文件

nc …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;nc命令全名为netcat，顾名思义就是通过TCP或UDP从网络读写数据。&lt;/p&gt;
&lt;p&gt;很多事情不一定非得抓包，nc也能发挥巨大作用。&lt;/p&gt;
&lt;h3 id="1"&gt;1、传输文件&lt;a class="headerlink" href="#1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id="_1"&gt;使用&amp;lt;&amp;gt;重定向符（只适用单文件，不推荐、失败时 &amp;ldquo;&amp;gt;&amp;rdquo; 产生空文件）&lt;a class="headerlink" href="#_1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nc -l 8888 &amp;lt; demo.txt        # 在本机8888端口侦听TCP连接，将收到的数据写入文件

nc ip 8888 &amp;gt; demo.txt       # 文件接收端：将文件内容通过网络&amp;quot;cat&amp;quot;到远端
&lt;/pre&gt;&lt;/div&gt;


&lt;h4 id="tar"&gt;使用tar传输文件（推荐，好处是保留了原目录结构和权限）&lt;a class="headerlink" href="#tar" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tar cz demo1.txt demo_dir/ | nc -l 8888  # 监听8888端口，有连接时开始tar打包并&amp;quot;cat&amp;quot;到远端

nc ip 8888 | tar zx                                 # 连接、接收数据、解压一步到位。
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="2"&gt;2、建立网络管道&lt;a class="headerlink" href="#2" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nc -l 8888                            # 接收消息

echo msg | nc ip 8888           # 发送消息
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="3"&gt;3、迁移生产机房数据到测试机房（运维电脑建管道）&lt;a class="headerlink" href="#3" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tar cz demo1.txt demo_dir/ | nc -l 8888  # 生产机房ipA

nc -l 8888 | tar zx                                 # 测试机房ipB

nc ipA 8888 | nc ipB 8888                      # 运维个人电脑，连通两台机器的8888端口。
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="4-lbgudp"&gt;4、测试网络连通 （排查测试机房的lbg转发udp问题）&lt;a class="headerlink" href="#4-lbgudp" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;curl 调试http，即7层非常高效。但如何调试4层网络呢？答案就是nc
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;测试机房lbg做了公网udp服务的映射，但测试同学发现程序出错，怀疑网络问题，找运维同学排查。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nc -ul 9999                   # 服务ipS 监听9999端口 该端口映射到公网 ipVS:portVS

nc -zuv ipS 9999           # 内网udp连通成功   显示Connection to ipS 9999 port [udp/*] succeeded!

nc -zuv ipVS portVS       # 公网udp连通失败   显示Connection to ipVS portVS port [udp/*] fail!

一、上如何检查tcp？以上的参数u去掉，默认就是tcp。

二、进一步写出nagios插件，检查udp服务端口（以部署在PP的udp消息推送监控中）
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="5telnetmc"&gt;5、代替telnet，测试mc，浮云等等。&lt;a class="headerlink" href="#5telnetmc" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;echo -e &amp;quot;stats\r\n&amp;quot; | nc ipS portMC        # 非交换式查看mc的状态。

echo -e &amp;quot;INFO\r\n&amp;quot; | nc ipS portREDIS   # 非交换式查看redis的状态。
&lt;/pre&gt;&lt;/div&gt;


&lt;!--非交换的set、get检查浮云ds        # 已部署到PP的浮云监控。--&gt;

&lt;h3 id="6nchttpshellman-nc"&gt;6、使用nc发邮件，发送http请求，反弹shell，端口转发等等，请man nc&lt;a class="headerlink" href="#6nchttpshellman-nc" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;echo -e &amp;quot;GET / HTTP/1.0\r\n&amp;quot; | nc uc.cn 80
&lt;/pre&gt;&lt;/div&gt;</content><category term="nc"></category><category term="tcp"></category><category term="netcat"></category><category term="网络"></category></entry></feed>